name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - "custom_components/**"
      - ".github/workflows/**"

permissions:
  contents: read
  security-events: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      switch_changed: ${{ steps.changes.outputs.switch_changed }}
      energy_report_changed: ${{ steps.changes.outputs.energy_report_changed }}
      workflow_changed: ${{ steps.changes.outputs.workflow_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check which components changed
          SWITCH_CHANGED=false
          ENERGY_CHANGED=false
          WORKFLOW_CHANGED=false

          if echo "$CHANGED_FILES" | grep -q "custom_components/switch_energy_statistics_estimation/"; then
            SWITCH_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -q "custom_components/energy_generation_report/"; then
            ENERGY_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -q ".github/workflows/"; then
            WORKFLOW_CHANGED=true
          fi

          echo "switch_changed=${SWITCH_CHANGED}" >> $GITHUB_OUTPUT
          echo "energy_report_changed=${ENERGY_CHANGED}" >> $GITHUB_OUTPUT
          echo "workflow_changed=${WORKFLOW_CHANGED}" >> $GITHUB_OUTPUT

          echo "Switch component changed: ${SWITCH_CHANGED}"
          echo "Energy report component changed: ${ENERGY_CHANGED}"
          echo "Workflow files changed: ${WORKFLOW_CHANGED}"

  python-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install validation tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort bandit pylint mypy
          pip install homeassistant voluptuous

      - name: Check code formatting with black
        run: |
          black --check --diff custom_components/

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff custom_components/

      - name: Security scan with bandit
        run: |
          bandit -r custom_components/ -f json -o bandit-report.json || true
          bandit -r custom_components/ -ll

      - name: Lint with pylint
        run: |
          pylint custom_components/ --exit-zero --reports=y --output-format=text

      - name: Type checking with mypy
        run: |
          mypy custom_components/ --ignore-missing-imports --no-strict-optional --exit-zero

  manifest-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate manifest files
        run: |
          # Check that manifest.json files are valid JSON
          for manifest in custom_components/*/manifest.json; do
            echo "Validating $manifest"
            jq . "$manifest" > /dev/null || {
              echo "ERROR: Invalid JSON in $manifest"
              exit 1
            }

            # Check required fields
            component_dir=$(dirname "$manifest")
            component_name=$(basename "$component_dir")

            # Validate required manifest fields
            domain=$(jq -r '.domain' "$manifest")
            name=$(jq -r '.name' "$manifest")
            version=$(jq -r '.version' "$manifest")

            if [ "$domain" == "null" ] || [ -z "$domain" ]; then
              echo "ERROR: Missing or invalid 'domain' in $manifest"
              exit 1
            fi

            if [ "$name" == "null" ] || [ -z "$name" ]; then
              echo "ERROR: Missing or invalid 'name' in $manifest"
              exit 1
            fi

            if [ "$version" == "null" ] || [ -z "$version" ]; then
              echo "ERROR: Missing or invalid 'version' in $manifest"
              exit 1
            fi

            # Validate version format (semantic versioning)
            if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
              echo "ERROR: Invalid version format '$version' in $manifest. Use semantic versioning (e.g., 1.0.0)"
              exit 1
            fi

            echo "✓ $manifest is valid"
          done

      - name: Check version consistency
        run: |
          # Check if versions were properly bumped for changed components
          if [ "${{ needs.detect-changes.outputs.switch_changed }}" = "true" ]; then
            echo "Checking switch component version..."
            SWITCH_VERSION=$(jq -r '.version' custom_components/switch_energy_statistics_estimation/manifest.json)
            echo "Switch component version: $SWITCH_VERSION"
          fi

          if [ "${{ needs.detect-changes.outputs.energy_report_changed }}" = "true" ]; then
            echo "Checking energy report component version..."
            ENERGY_VERSION=$(jq -r '.version' custom_components/energy_generation_report/manifest.json)
            echo "Energy report component version: $ENERGY_VERSION"
          fi

  workflow-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.workflow_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          # Install yq for YAML validation
          sudo snap install yq

          # Check all workflow YAML files
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "Validating $workflow"
              yq eval '.' "$workflow" > /dev/null || {
                echo "ERROR: Invalid YAML syntax in $workflow"
                exit 1
              }
              echo "✓ $workflow is valid YAML"
            fi
          done

      - name: Test workflow syntax with act (dry-run)
        run: |
          # Install act for local GitHub Actions testing
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash -s -- -b /usr/local/bin

          # Verify act is installed
          which act
          act --version

          # Test workflow syntax (dry-run only, allow some failures as expected)
          echo "Testing workflow syntax..."
          if act --list --verbose 2>&1 | grep -q "Error\\|ERROR"; then
            echo "WARNING: Some workflow issues detected, but this may be expected in CI environment"
            echo "Checking for critical syntax errors..."

            # Check for YAML syntax errors specifically
            if act --list 2>&1 | grep -q "yaml\\|YAML\\|syntax"; then
              echo "ERROR: YAML syntax errors found"
              exit 1
            fi

            echo "No critical syntax errors found"
          else
            echo "✓ Workflow syntax validation passed"
          fi

  security-scan:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Semgrep Security Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/bandit
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  component-structure-validation:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate component structure
        run: |
          # Check required files for Home Assistant components
          for component_dir in custom_components/*/; do
            component_name=$(basename "$component_dir")
            echo "Validating structure for $component_name"

            # Check required files
            required_files=("__init__.py" "manifest.json")
            for file in "${required_files[@]}"; do
              file_path="${component_dir}${file}"
              if [ ! -f "$file_path" ]; then
                echo "ERROR: Missing required file $file in $component_dir"
                exit 1
              fi
              echo "✓ Found $file in $component_dir"
            done

            # Check that __init__.py has meaningful content
            init_file="${component_dir}__init__.py"
            if [ -f "$init_file" ]; then
              # Count non-empty, non-comment lines
              content_lines=$(grep -v '^[[:space:]]*$' "$init_file" | grep -v '^[[:space:]]*#' | wc -l)
              if [ "$content_lines" -eq 0 ]; then
                echo "ERROR: __init__.py contains no meaningful content in $component_dir"
                exit 1
              fi
              echo "✓ __init__.py has $content_lines lines of meaningful content"
            fi

            # Check manifest.json is valid JSON
            manifest_file="${component_dir}manifest.json"
            if [ -f "$manifest_file" ]; then
              if ! python -m json.tool "$manifest_file" > /dev/null 2>&1; then
                echo "ERROR: manifest.json is not valid JSON in $component_dir"
                exit 1
              fi
              echo "✓ manifest.json is valid JSON"
            fi

            # Check for translations directory if it exists
            if [ -d "$component_dir/translations" ]; then
              if [ ! -f "$component_dir/translations/en.json" ]; then
                echo "WARNING: translations directory exists but en.json is missing in $component_dir"
              else
                echo "✓ Found translations/en.json"
              fi
            fi

            echo "✓ Structure validation passed for $component_name"
          done

  integration-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Home Assistant core (for testing)
        run: |
          python -m pip install --upgrade pip
          pip install homeassistant pytest pytest-homeassistant-custom-component

      - name: Basic import test
        run: |
          # Test that components can be imported without syntax errors
          cd custom_components
          for component_dir in */; do
            component_name=$(basename "$component_dir")
            echo "Testing import for $component_name"

            # Test basic imports using a simple python command
            if python -c "import sys; sys.path.insert(0, '.'); import $component_name; print('✓ Successfully imported $component_name')" 2>&1; then
              echo "Import test passed for $component_name"
            else
              echo "WARNING: Import test failed for $component_name (this may be expected if dependencies are missing)"
            fi
          done

  pr-summary:
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        python-validation,
        manifest-validation,
        workflow-validation,
        security-scan,
        component-structure-validation,
        integration-test,
      ]
    if: always()
    steps:
      - name: PR Validation Summary
        run: |
          echo "# Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Changed Components" >> $GITHUB_STEP_SUMMARY
          echo "- Switch Energy Statistics: ${{ needs.detect-changes.outputs.switch_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Energy Generation Report: ${{ needs.detect-changes.outputs.energy_report_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Files: ${{ needs.detect-changes.outputs.workflow_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- Python Validation: ${{ needs.python-validation.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest Validation: ${{ needs.manifest-validation.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Validation: ${{ needs.workflow-validation.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Validation: ${{ needs.component-structure-validation.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Test: ${{ needs.integration-test.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY

          # Check if any validation failed
          if [[ "${{ needs.python-validation.result }}" == "failure" ||
                "${{ needs.manifest-validation.result }}" == "failure" ||
                "${{ needs.workflow-validation.result }}" == "failure" ||
                "${{ needs.security-scan.result }}" == "failure" ||
                "${{ needs.component-structure-validation.result }}" == "failure" ||
                "${{ needs.integration-test.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **PR validation failed. Please fix the issues above before merging.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All validations passed. PR is ready for review.**" >> $GITHUB_STEP_SUMMARY
          fi
