name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      switch_changed: ${{ steps.changes.outputs.switch_changed }}
      energy_report_changed: ${{ steps.changes.outputs.energy_report_changed }}
      switch_version: ${{ steps.changes.outputs.switch_version }}
      energy_report_version: ${{ steps.changes.outputs.energy_report_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}"

      - name: Detect changes
        id: changes
        run: |
          if [ -z "${{ steps.prev_tag.outputs.PREV_TAG }}" ]; then
            echo "switch_changed=true" >> $GITHUB_OUTPUT
            echo "energy_report_changed=true" >> $GITHUB_OUTPUT
          else
            SWITCH_CHANGES=$(git diff --name-only ${{ steps.prev_tag.outputs.PREV_TAG }} HEAD -- custom_components/switch_energy_statistics_estimation/)
            ENERGY_CHANGES=$(git diff --name-only ${{ steps.prev_tag.outputs.PREV_TAG }} HEAD -- custom_components/energy_generation_report/)
            
            if [ -n "$SWITCH_CHANGES" ]; then
              echo "switch_changed=true" >> $GITHUB_OUTPUT
            else
              echo "switch_changed=false" >> $GITHUB_OUTPUT
            fi
            
            if [ -n "$ENERGY_CHANGES" ]; then
              echo "energy_report_changed=true" >> $GITHUB_OUTPUT
            else
              echo "energy_report_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

          # Get versions from manifest files
          SWITCH_VERSION=$(grep '"version"' custom_components/switch_energy_statistics_estimation/manifest.json | cut -d'"' -f4)
          ENERGY_VERSION=$(grep '"version"' custom_components/energy_generation_report/manifest.json | cut -d'"' -f4)

          echo "switch_version=${SWITCH_VERSION}" >> $GITHUB_OUTPUT
          echo "energy_report_version=${ENERGY_VERSION}" >> $GITHUB_OUTPUT

          echo "Switch changed: $([ -n "$SWITCH_CHANGES" ] && echo true || echo false)"
          echo "Energy report changed: $([ -n "$ENERGY_CHANGES" ] && echo true || echo false)"

  release:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.switch_changed == 'true' || needs.detect-changes.outputs.energy_report_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create ZIP archives
        run: |
          cd custom_components

          # Create switch component archive if changed
          if [ "${{ needs.detect-changes.outputs.switch_changed }}" = "true" ]; then
            zip -r ../switch_energy_statistics_estimation-${{ steps.version.outputs.VERSION }}.zip switch_energy_statistics_estimation/
            echo "Created switch component archive"
          fi

          # Create energy report component archive if changed  
          if [ "${{ needs.detect-changes.outputs.energy_report_changed }}" = "true" ]; then
            zip -r ../energy_generation_report-${{ steps.version.outputs.VERSION }}.zip energy_generation_report/
            echo "Created energy report component archive"
          fi

          cd ..

      - name: Generate release notes
        id: release_notes
        run: |
          NOTES="## Release ${{ steps.version.outputs.VERSION }}\n\n"

          if [ "${{ needs.detect-changes.outputs.switch_changed }}" = "true" ]; then
            NOTES+="### ðŸ”Œ Switch Energy Statistics Estimation v${{ needs.detect-changes.outputs.switch_version }}\n\n"
            NOTES+="Multi-gang switch energy consumption tracking with Home Assistant Energy Dashboard integration.\n\n"
            NOTES+="**Features:**\n"
            NOTES+="- Multi-gang switch support (1-8 gangs)\n"
            NOTES+="- Energy consumption tracking (daily, weekly, monthly)\n"
            NOTES+="- Configurable power consumption per gang\n"
            NOTES+="- Historical data persistence\n\n"
          fi

          if [ "${{ needs.detect-changes.outputs.energy_report_changed }}" = "true" ]; then
            NOTES+="### âš¡ Energy Generation Report v${{ needs.detect-changes.outputs.energy_report_version }}\n\n"
            NOTES+="Comprehensive solar energy generation reporting with interactive charts and billing period management.\n\n"
            NOTES+="**Features:**\n"
            NOTES+="- Solar energy tracking with flexible billing periods\n"
            NOTES+="- Grid consumption and injection monitoring\n"
            NOTES+="- Cumulative balance tracking with utility companies\n"
            NOTES+="- Interactive ApexCharts visualizations\n"
            NOTES+="- Service integration for easy data entry\n\n"
          fi

          NOTES+="## Installation via HACS\n"
          NOTES+="1. Add \`https://github.com/danielulisses/zigbee-devices\` as a custom repository in HACS\n"
          NOTES+="2. Search for the component you want to install\n"
          NOTES+="3. Install and restart Home Assistant\n"
          NOTES+="4. Add the integration through Settings â†’ Devices & Services\n\n"

          NOTES+="## Manual Installation\n"
          NOTES+="1. Download the appropriate ZIP file below\n"
          NOTES+="2. Extract to your \`custom_components/\` directory\n"
          NOTES+="3. Restart Home Assistant\n\n"

          NOTES+="### What's Changed\n"
          NOTES+="- See commit history for detailed changes"

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}

      - name: Upload Switch Component ZIP
        if: needs.detect-changes.outputs.switch_changed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./switch_energy_statistics_estimation-${{ steps.version.outputs.VERSION }}.zip
          asset_name: switch_energy_statistics_estimation-${{ steps.version.outputs.VERSION }}.zip
          asset_content_type: application/zip

      - name: Upload Energy Report Component ZIP
        if: needs.detect-changes.outputs.energy_report_changed == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./energy_generation_report-${{ steps.version.outputs.VERSION }}.zip
          asset_name: energy_generation_report-${{ steps.version.outputs.VERSION }}.zip
          asset_content_type: application/zip
